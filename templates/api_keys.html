{% extends "layout.html" %}

{% block title %}API Key Management{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">API Key Management</h1>
    
    <div class="alert alert-info">
        <p><strong>API Keys</strong> are used to connect to external services like SerpAPI for Google search results. 
        Having multiple API keys increases reliability by providing fallback options when one key reaches rate limits or has errors.</p>
    </div>

    <!-- Add New API Key Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title h5 mb-0">Add New API Key</h3>
        </div>
        <div class="card-body">
            <form action="{{ url_for('manage_api_keys') }}" method="POST">
                <input type="hidden" name="action" value="add">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="service" class="form-label">Service</label>
                            <select name="service" id="service" class="form-select" required>
                                <option value="serpapi" selected>SerpAPI (Google Search)</option>
                                <option value="openai">OpenAI (AI Completions)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="name" class="form-label">Key Name</label>
                            <input type="text" name="name" id="name" class="form-control" placeholder="e.g., Primary Google Key" required>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="key" class="form-label">API Key</label>
                            <input type="text" name="key" id="key" class="form-control" placeholder="Enter your API key" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="priority" class="form-label">Priority (Lower number = Higher priority)</label>
                            <input type="number" name="priority" id="priority" class="form-control" value="10" min="0" max="100">
                            <div class="form-text">Keys with lower priority numbers are used first.</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input type="checkbox" name="is_active" id="is_active" class="form-check-input" value="1" checked>
                            <label for="is_active" class="form-check-label">Active</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="submit" class="btn btn-primary">Add Key</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- API Keys List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title h5 mb-0">Existing API Keys</h3>
            <span class="badge bg-primary">{{ api_keys|length }} Keys</span>
        </div>
        <div class="card-body p-0">
            {% if api_keys %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Name</th>
                            <th>Key</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Usage</th>
                            <th>Last Used</th>
                            <th>Last Error</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in api_keys %}
                        <tr>
                            <td>{{ key.service }}</td>
                            <td>{{ key.name }}</td>
                            <td>
                                <span class="text-truncate d-inline-block" style="max-width: 160px;" title="{{ key.key }}">
                                    {{ key.key[:4] }}...{{ key.key[-4:] }}
                                </span>
                            </td>
                            <td>{{ key.priority }}</td>
                            <td>
                                {% if key.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ key.usage_count }}</td>
                            <td>
                                {% if key.last_used %}
                                <span title="{{ key.last_used }}">{{ key.last_used.strftime('%Y-%m-%d %H:%M') }}</span>
                                {% else %}
                                <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if key.last_error %}
                                <span class="text-truncate d-inline-block" style="max-width: 160px;" title="{{ key.last_error }}">
                                    {{ key.last_error[:20] }}{% if key.last_error|length > 20 %}...{% endif %}
                                </span>
                                {% else %}
                                <span class="text-muted">None</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <form action="{{ url_for('manage_api_keys') }}" method="POST" class="d-inline">
                                        <input type="hidden" name="action" value="toggle">
                                        <input type="hidden" name="key_id" value="{{ key.id }}">
                                        <button type="submit" class="btn btn-sm {% if key.is_active %}btn-warning{% else %}btn-success{% endif %}">
                                            {% if key.is_active %}Disable{% else %}Enable{% endif %}
                                        </button>
                                    </form>
                                    <form action="{{ url_for('manage_api_keys') }}" method="POST" class="d-inline ms-1">
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="key_id" value="{{ key.id }}">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this API key?');">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning m-3">
                No API keys found. Please add your first API key using the form above.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}