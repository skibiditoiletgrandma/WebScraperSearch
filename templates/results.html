{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Search Results for "{{ query }}"</h2>

    <form action="{{ url_for('search') }}" method="post" class="mt-4 mb-4">
        <div class="input-group">
            <input type="text" class="form-control" id="search-input" name="query" value="{{ query }}" placeholder="Enter your search query">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-1"></i> Search
            </button>
        </div>

        <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="research-mode" name="research_mode" value="1" {% if research_mode %}checked{% endif %}>
            <label class="form-check-label" for="research-mode">
                <i class="fas fa-graduation-cap me-1"></i> Research Mode (limit to .edu, .org, .gov sites)
            </label>
        </div>
    </form>

    <div class="mb-4">
        <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Back to Home
        </a>

        <a href="{{ url_for('history') }}" class="btn btn-info">
            <i class="fas fa-history me-1"></i> View Search History
        </a>

        {% if from_history %}
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            You are viewing results from search history.
        </div>
        {% endif %}
    </div>

    {% if enable_suggestions %}
    <!-- Personalized Search Recommendation Sidebar -->
    <div class="container-fluid">
        <div class="row">
            <!-- Main content -->
            <div class="col-md-8 col-lg-9">
                <!-- Original results content will be appended here by JavaScript -->
                <div id="main-content-container"></div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4 col-lg-3">
                <div id="recommendations-sidebar" class="sticky-top" style="top: 20px;">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>
                                Personalized Recommendations
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Error message section -->
                            <div id="suggestions-error" class="alert alert-danger d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Failed to generate personalized recommendations. Please try again later.
                            </div>

                            <!-- History section -->
                            <div id="personal-history-section" class="d-none">
                                <div class="p-3 border-bottom">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-history me-2"></i>
                                        Your Search History
                                    </h6>
                                    <div id="personal-history-list" class="recommendation-section">
                                        <!-- Personal history items will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Trending section -->
                            <div id="trending-section" class="d-none">
                                <div class="p-3 border-bottom">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-fire me-2"></i>
                                        Trending Searches
                                    </h6>
                                    <div id="trending-list" class="recommendation-section">
                                        <!-- Trending searches will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Related topics section -->
                            <div id="topics-section" class="d-none">
                                <div class="p-3 border-bottom">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-tag me-2"></i>
                                        Related Topics
                                    </h6>
                                    <div id="topics-list" class="recommendation-section">
                                        <!-- Topic suggestions will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Query improvements section -->
                            <div id="query-improvements-section" class="d-none">
                                <div class="p-3">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-magic me-2"></i>
                                        Query Improvements
                                    </h6>
                                    <div id="query-improvements-list" class="recommendation-section">
                                        <!-- Query improvement suggestions will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legacy container for backward compatibility -->
    <div id="suggestions-container" class="d-none mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    Search Suggestions
                </h5>
                <div id="suggestions-list" class="list-group list-group-flush">
                    <!-- Suggestions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if results %}
    <div class="results-container">
        {% for result in results %}
        <div class="card mb-4 shadow-sm result-card">
            <div class="card-body">
                <h5 class="card-title">
                    <a href="{{ result.link }}" target="_blank" rel="noopener noreferrer">
                        {{ result.title }}
                    </a>
                </h5>
                <p class="text-muted mb-2">
                    <small>{{ result.link }}</small>
                </p>
                <p class="card-text">{{ result.description }}</p>

                {% if generate_summaries %}
                <div class="summary-section mt-3">
                    <h6 class="text-muted">
                        <i class="fas fa-file-alt me-2"></i>Summary
                    </h6>
                    <p>{{ result.summary }}</p>
                </div>
                {% endif %}

                {% if not show_feedback %}
                <div class="feedback-section mt-3">
                    <form action="{{ url_for('submit_feedback', result_id=result.id) }}" method="post">
                        <div class="rating-stars mb-2">
                            {% for i in range(1, 6) %}
                            <input type="radio" id="star{{ i }}_{{ result.id }}" name="rating" value="{{ i }}">
                            <label for="star{{ i }}_{{ result.id }}"><i class="far fa-star"></i></label>
                            {% endfor %}
                        </div>
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input type="checkbox" class="form-check-input" id="helpful_{{ result.id }}" name="helpful">
                                <label class="form-check-label" for="helpful_{{ result.id }}">Helpful</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input type="checkbox" class="form-check-input" id="accurate_{{ result.id }}" name="accurate">
                                <label class="form-check-label" for="accurate_{{ result.id }}">Accurate</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input type="checkbox" class="form-check-input" id="complete_{{ result.id }}" name="complete">
                                <label class="form-check-label" for="complete_{{ result.id }}">Complete</label>
                            </div>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" name="comment" rows="2" placeholder="Optional feedback..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-primary">Submit Feedback</button>
                    </form>
                </div>
                {% endif %}

                <div class="share-buttons mt-3">
                    <button class="btn btn-sm btn-outline-info me-2 share-button" 
                            data-result-id="{{ result.id }}"
                            data-title="{{ result.title }}"
                            data-description="{{ result.description }}"
                            data-summary="{{ result.summary }}">
                        <i class="fas fa-share-alt me-1"></i>Share
                        <span class="badge bg-secondary ms-1">{{ result.share_count or 0 }}</span>
                    </button>
                </div>
                <!-- Share functionality now uses the modal popup instead of toast -->
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>No results found.
    </div>
    {% endif %}
</div>

<!-- Share Modal Dialog -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share-alt me-2"></i>Share Result
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-success mb-3">
                    <i class="fas fa-check-circle me-2"></i>Link copied to clipboard!
                </p>
                <div class="input-group">
                    <input type="text" id="share-link-input" class="form-control" readonly>
                    <button class="btn btn-outline-secondary copy-again-btn" type="button">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% if enable_suggestions %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // First, move all the current content to the main-content-container
    const mainContentContainer = document.getElementById('main-content-container');
    const resultsContainer = document.querySelector('.results-container');
    const alertInfo = document.querySelector('.alert-info');

    if (mainContentContainer) {
        // Move search results if they exist
        if (resultsContainer) {
            mainContentContainer.appendChild(resultsContainer.cloneNode(true));
            if (resultsContainer.parentNode) {
                resultsContainer.parentNode.removeChild(resultsContainer);
            }
        }

        // Move "No results found" alert if it exists
        if (alertInfo) {
            mainContentContainer.appendChild(alertInfo.cloneNode(true));
            if (alertInfo.parentNode) {
                alertInfo.parentNode.removeChild(alertInfo);
            }
        }
    }

    // Handle search input and suggestions
    const searchInput = document.getElementById('search-input');

    // Legacy suggestion containers (for backward compatibility)
    const suggestionsContainer = document.getElementById('suggestions-container');
    const suggestionsList = document.getElementById('suggestions-list');

    // New sidebar section containers
    const personalHistorySection = document.getElementById('personal-history-section');
    const trendingSection = document.getElementById('trending-section');
    const topicsSection = document.getElementById('topics-section');
    const queryImprovementsSection = document.getElementById('query-improvements-section');

    // New sidebar list containers
    const personalHistoryList = document.getElementById('personal-history-list');
    const trendingList = document.getElementById('trending-list');
    const topicsList = document.getElementById('topics-list');
    const queryImprovementsList = document.getElementById('query-improvements-list');

    let typingTimer;
    const doneTypingInterval = 500;
    const initialQuery = document.querySelector('h2')?.textContent?.match(/"([^"]+)"/)?.[1] || '';

    // Setup input event handlers for both main search and research mode
    const searchInputs = document.querySelectorAll('input[type="search"], input[name="query"]');
    searchInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(typingTimer);
            if (this.value.length >= 2) {
                typingTimer = setTimeout(() => fetchRecommendations(this.value), doneTypingInterval);
            } else {
                clearAndHideAllSections();
            }
        });
    });

    // Immediately fetch recommendations on page load if we have an initial query
    if (initialQuery) {
        fetchRecommendations(initialQuery);
    }

    function fetchRecommendations(query) {
        if (!query) return;

        fetch(`/api/suggestions?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display grouped suggestions in the sidebar
                    if (data.grouped_suggestions) {
                        displayGroupedRecommendations(data.grouped_suggestions);
                    }

                    // For backward compatibility, also display in the old format
                    if (data.suggestions && data.suggestions.length > 0 && suggestionsList) {
                        displayLegacySuggestions(data.suggestions);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                document.getElementById('suggestions-error').classList.remove('d-none');
            });
    }

    function displayGroupedRecommendations(groupedSuggestions) {
        // Clear and hide all sections including error message
        clearAndHideAllSections();
        document.getElementById('suggestions-error').classList.add('d-none');

        // Display personalized history
        if (groupedSuggestions.personalized && groupedSuggestions.personalized.length > 0) {
            displaySectionItems(personalHistoryList, personalHistorySection, groupedSuggestions.personalized);
        }

        // Display trending searches
        if (groupedSuggestions.trending && groupedSuggestions.trending.length > 0) {
            displaySectionItems(trendingList, trendingSection, groupedSuggestions.trending);
        }

        // Display topic suggestions
        if (groupedSuggestions.topic && groupedSuggestions.topic.length > 0) {
            displaySectionItems(topicsList, topicsSection, groupedSuggestions.topic);
        }

        // Display query improvements
        if (groupedSuggestions.improved) {
            displaySectionItems(queryImprovementsList, queryImprovementsSection, groupedSuggestions.improved);
        }

        // Display expanded and operator suggestions
        if (groupedSuggestions.expanded || groupedSuggestions.operator) {
            const improvements = [
                ...(groupedSuggestions.expanded || []),
                ...(groupedSuggestions.operator || [])
            ];
            if (improvements.length > 0) {
                displaySectionItems(queryImprovementsList, queryImprovementsSection, improvements);
            }
        }
    }

    function clearAndHideAllSections() {
        // Clear and hide all sections
        if (personalHistoryList) personalHistoryList.innerHTML = '';
        if (personalHistorySection) personalHistorySection.classList.add('d-none');

        if (trendingList) trendingList.innerHTML = '';
        if (trendingSection) trendingSection.classList.add('d-none');

        if (topicsList) topicsList.innerHTML = '';
        if (topicsSection) topicsSection.classList.add('d-none');

        if (queryImprovementsList) queryImprovementsList.innerHTML = '';
        if (queryImprovementsSection) queryImprovementsSection.classList.add('d-none');
    }

    function displaySectionItems(listElement, sectionElement, items) {
        if (!listElement || !sectionElement || !items.length) return;

        listElement.innerHTML = '';

        items.forEach(item => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary me-2 mb-2';
            button.type = 'button';

            // Use provided icon or default based on type
            let iconClass = item.icon || 'fa-lightbulb';

            button.innerHTML = `
                <i class="fas ${iconClass} me-2"></i>
                ${item.query}
            `;

            // Add tooltip with description
            if (item.description) {
                button.setAttribute('data-bs-toggle', 'tooltip');
                button.setAttribute('data-bs-placement', 'top');
                button.setAttribute('title', item.description);
            }

            button.addEventListener('click', function() {
                if (searchInput) {
                    searchInput.value = item.query;
                    searchInput.form.submit();
                } else {
                    // If searchInput is not available, create a form and submit
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/search';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'query';
                    input.value = item.query;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            });

            listElement.appendChild(button);
        });

        // Show section since we have items
        sectionElement.classList.remove('d-none');

        // Initialize tooltips for new buttons
        const tooltipTriggerList = [].slice.call(listElement.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // For backward compatibility with old suggestion display
    function displayLegacySuggestions(suggestions) {
        if (!suggestionsList) return;

        suggestionsList.innerHTML = '';

        suggestions.slice(0, 5).forEach(suggestion => {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action py-2';
            item.href = '#';

            // Get icon from suggestion or use default based on type
            let iconClass = suggestion.icon || 'fa-lightbulb';
            if (suggestion.type === 'operator') {
                iconClass = 'fa-code';
            } else if (suggestion.type === 'expanded') {
                iconClass = 'fa-plus-circle';
            }

            item.innerHTML = `
                <div>
                    <i class="fas ${iconClass} text-muted me-2"></i>
                    <strong>${suggestion.query}</strong>
                </div>
                <small class="text-muted">${suggestion.description}</small>
            `;

            item.addEventListener('click', function(e) {
                e.preventDefault();
                if (searchInput) {
                    searchInput.value = suggestion.query;
                    suggestionsContainer.classList.add('d-none');
                    searchInput.form.submit();
                }
            });

            suggestionsList.appendChild(item);
        });

        if (suggestionsList.children.length > 0 && suggestionsContainer) {
            suggestionsContainer.classList.remove('d-none');
        }
    }

    // Handle share buttons
    document.querySelectorAll('.share-button').forEach(button => {
        button.addEventListener('click', async function() {
            const resultId = this.getAttribute('data-result-id');
            const title = this.getAttribute('data-title');
            const description = this.getAttribute('data-description');
            const summary = this.getAttribute('data-summary');

            try {
                // Call API to increment share count
                const response = await fetch(`/api/share/${resultId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Copy share URL to clipboard
                    await navigator.clipboard.writeText(data.share_url);

                    // Update share count badge
                    const badge = this.querySelector('.badge');
                    if (badge) {
                        badge.textContent = data.share_count;
                    }

                    // Set the URL in the modal input field
                    const shareInput = document.getElementById('share-link-input');
                    if (shareInput) {
                        shareInput.value = data.share_url;
                    }

                    // Show the modal
                    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
                    shareModal.show();
                }
            } catch (error) {
                console.error('Error sharing:', error);
                showAlert('Error sharing result. Please try again.', 'danger');
            }
        });
    });

    // Handle copy buttons
    const copyButtons = document.querySelectorAll('.copy-btn');
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const textToCopy = this.getAttribute('data-text');
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = 'Copied!';
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 2000);
            });
        });
    });

    // Handle the copy-again button in share modal
    const copyAgainBtn = document.querySelector('.copy-again-btn');
    if (copyAgainBtn) {
        copyAgainBtn.addEventListener('click', function() {
            const shareInput = document.getElementById('share-link-input');
            if (shareInput && shareInput.value) {
                // Select the text for better visual feedback
                shareInput.select();
                // Copy to clipboard
                navigator.clipboard.writeText(shareInput.value).then(() => {
                    // Show feedback
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showAlert('Failed to copy to clipboard', 'danger');
                });
            }
        });
    }
});
</script>

<style>
/* Styling for recommendation sidebar */
.recommendation-section {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.recommendation-section .btn {
    font-size: 0.9rem;
    padding: 0.3rem 0.6rem;
    white-space: normal;
    text-align: left;
    border-radius: 20px;
}

/* Sticky sidebar for desktop */
@media (min-width: 768px) {
    #recommendations-sidebar {
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        position: sticky;
        top: 20px;
    }
}

/* Type-specific styling */
.recommendation-section .btn[data-type="history"] {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.recommendation-section .btn[data-type="trending"] {
    border-color: #fd7e14;
}

.recommendation-section .btn[data-type="topic"] {
    border-color: #20c997;
}

.recommendation-section .btn[data-type="improved"],
.recommendation-section .btn[data-type="expanded"],
.recommendation-section .btn[data-type="operator"] {
    border-color: #0d6efd;
}
</style>
{% endif %}
{% endblock %}